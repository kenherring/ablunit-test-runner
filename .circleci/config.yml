version: 2.1

orbs:
  shellcheck: circleci/shellcheck@3.2.0
  sonarcloud: sonarsource/sonarcloud@2.0.0

workflows:
  build:
    jobs:
      - shellcheck/check
      - test-and-scan:
          context:
            - DockerHub
            - PROGRESS_CFG
          filters:
            tags:
              only:
                - /^v.*/
      - package-and-publish:
          requires:
            - shellcheck/check
            - test-and-scan
          context:
            - Azure_PAT
          filters:
            tags:
              only:
                - /^v.*/

jobs:
  test-and-scan:
    docker:
      - image: kherring/ablunit-test-runner
        auth:
          username: kherring
          password: $DOCKERHUB_TOKEN
    steps:
      - run: tr ' ' '\n' \<<< "$PROGRESS_CFG_BASE64" | base64 --decode > /psc/dlc/progress.cfg
      - checkout
      - restore_cache:
          keys:
            - v1-nodemodules-{{ checksum "package.json" }}
            - v1-nodemodules-
      - restore_cache:
          keys:
            - v1-vscode-test-1.84.2
      - run: .circleci/run_test_wrapper.sh
      # - run: rm artifacts/eslint_report_junit.xml
      - store_test_results:
          when: always
          path: artifacts/
      - store_artifacts:
          when: always
          path: artifacts/
      - run: .circleci/validate.sh
      - sonarcloud/scan
      - save_cache:
          key: v1-nodemodules-{{ checksum "package.json" }}
          paths:
            - node_modules
      - save_cache:
          key: v1-vscode-test-1.84.2
          paths:
            - .vscode-test
      - persist_to_workspace:
          root: .
          paths:
            - .
  package-and-publish:
    docker:
      - image: cimg/node:20.8
    steps:
      - checkout
      - run: npm install
      - run: sudo npm install -g @vscode/vsce
      - run:
          name: vsce package
          command: |
            vsce package \
                --pre-release \
                --githubBranch "$(git branch --show-current)"
      - run: vsce ls
      - run:
          name: install and run
          command: |
            cd dummy-ext
            npm run compile
            npm run test:install-and-run
      - when:
          condition: << pipeline.git.tag >>
          steps:
          - run:
              name: validate version matches tag
              command: |
                if [ "$(jq -r .version package.json)" != "${CIRCLE_TAG#v}" ]; then
                  echo "Version in package.json does not match tag"
                  exit 1
                fi
          - run:
              name: vsce publish
              command: |
                vsce publish
                    --pre-release
                    --packagePath ablunit-test-provider-<< pipeline.git.tag >>.vsix
                    --githubBranch "$(git branch --show-current)"
      - run: mkdir -p artifacts && cp ablunit-test-provider-*.vsix artifacts
      - store_artifacts:
          when: always
          path: artifacts
